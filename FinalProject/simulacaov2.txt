globals [
  dias
  chovendo?
]

patches-own [
  is-building?
  is-drain?
  lixo
  entupido?
]

turtles-own [
  tipo
]

to setup
  clear-all
  set dias 0
  set chovendo? false

  ask patches [
    set is-building? false
    set is-drain? false
    set entupido? false
    set lixo 0
  ]

  draw-region
  create-buildings
  place-drains

  reset-ticks
end

to draw-region
  ask patches with [pycor = 5 or pycor = 6] [set pcolor gray - 1]
  ask patches with [pycor = -5 or pycor = -6] [set pcolor gray - 1]
  ask patches with [pxcor = -10 or pxcor = -11] [set pcolor gray - 1]
  ask patches with [pxcor = 10 or pxcor = 11] [set pcolor gray - 1]
  ask patches with [pcolor = black] [set pcolor green + 2]
end

to create-buildings
  ask patches with [(pxcor > -9 and pxcor < 0 and pycor > 6 and pycor < 14)] [
    set pcolor red + 1
    set is-building? true
  ]
  ask patches with [(pxcor > 0 and pxcor < 9 and pycor > 6 and pycor < 14)] [
    set pcolor green + 3
    set is-building? true
  ]
  ask patches with [(pxcor > -9 and pxcor < -3 and pycor > -12 and pycor < -6)] [
    set pcolor violet + 1
    set is-building? true
  ]
  ask patches with [(pxcor > -3 and pxcor < 3 and pycor > -12 and pycor < -6)] [
    set pcolor brown + 2
    set is-building? true
  ]
  ask patches with [(pxcor > 3 and pxcor < 9 and pycor > -12 and pycor < -6)] [
    set pcolor blue + 10
    set is-building? true
  ]
  ask patches with [(pxcor > -9 and pxcor < 9 and pycor > -4 and pycor < 4)] [
    set pcolor orange + 2
    set is-building? true
  ]
end

to place-drains
  ask patches with [
    (pxcor = -10 and pycor = 6) or
    (pxcor = 10 and pycor = 6) or
    (pxcor = -10 and pycor = -6) or
    (pxcor = 10 and pycor = -6) or
    (pxcor = 0 and pycor = 5) or
    (pxcor = 0 and pycor = -5)
  ] [
    set is-drain? true
    set entupido? false
    set pcolor blue
  ]
end

to go
  if chovendo? [
    fazer-chover
    chuva
  ]

  acumular-lixo
  desenhar-niveis
  tick
end

to chuva
  ask patches with [is-drain?] [
    set pcolor blue + 3
  ]

  if any? patches with [is-drain? and lixo >= 10] [
    espalhar-agua
    desenhar-niveis
  ]
end

to ativar-chuva
  set chovendo? true
end

to parar-chuva
  set chovendo? false
end

to fazer-chover
  if chovendo? [
    ; só pinta ruas se houver bueiro entupido
    if any? patches with [is-drain? and entupido?] [
      pintar-ruas-azul
    ]
  ]
end

to pintar-ruas-azul
  ask patches with [is-drain? and entupido?] [
    let vizinhos patches in-radius 2
    ask vizinhos with [pcolor = gray - 1 and not is-building?] [
      set pcolor blue + 3
    ]
  ]
end

; botão pode chamar diretamente este se quiser ação independente da chuva
to pintar-ruas-se-entupido
  if any? patches with [is-drain? and entupido?] [
    pintar-ruas-azul
  ]
end

to espalhar-agua
  if not chovendo? [ stop ]

  if any? patches with [is-drain? and entupido?] [
    ask patches with [pcolor = gray - 1 and not is-building?] [
      let vizinhos patches in-radius 1
      if any? vizinhos with [pcolor = gray - 1 and not is-building?] [
        ask one-of vizinhos with [pcolor = gray - 1 and not is-building?] [
          set pcolor blue + 3
        ]
      ]
    ]
  ]
end

to acumular-lixo
  ask patches with [pcolor = gray - 1 or is-drain?] [
    let chance 0.05
    if random-float 1.0 < chance [
      set lixo lixo + 1
    ]
    if is-drain? and lixo > 10 [
      set entupido? true
    ]
  ]
end

to desenhar-niveis
  ask patches [
    if is-drain? [
      ifelse entupido? [
        set pcolor red
      ] [
        set pcolor blue + 2
      ]
      set plabel (word "Lixo: " lixo)
    ]
    if not is-drain? [
      set plabel ""
    ]
  ]
end
